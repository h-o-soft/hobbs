# HOBBS - 機能仕様書: RSSリーダー

## 1. 概要

外部サイトのRSSフィードを購読し、BBS上で最新記事を閲覧できる機能。

## 2. 基本仕様

| 項目 | 仕様 |
|------|------|
| 対応フォーマット | RSS 0.9x/1.0/2.0, Atom 0.3/1.0 |
| フィード登録権限 | SubOp/SysOpのみ |
| 閲覧権限 | ゲスト含む全員 |
| 既読管理 | 会員のみ（ゲストは既読管理なし） |
| 更新方式 | バックグラウンド定期更新 |

## 3. データ構造

### 3.1 RSSフィード

| 属性 | 型 | 説明 |
|------|-----|------|
| id | INTEGER | フィードID |
| url | TEXT | フィードURL |
| title | TEXT | フィード名 |
| description | TEXT | 説明 |
| site_url | TEXT | サイトURL |
| last_fetched_at | TEXT | 最終取得日時 |
| last_item_at | TEXT | 最新記事日時 |
| fetch_interval | INTEGER | 取得間隔（秒） |
| is_active | INTEGER | 有効フラグ |
| error_count | INTEGER | 連続エラー回数 |
| last_error | TEXT | 最後のエラー |
| created_by | INTEGER | 登録者ID |
| created_at | TEXT | 登録日時 |
| updated_at | TEXT | 更新日時 |

### 3.2 RSS記事

| 属性 | 型 | 説明 |
|------|-----|------|
| id | INTEGER | 記事ID |
| feed_id | INTEGER | フィードID |
| guid | TEXT | 記事固有ID |
| title | TEXT | タイトル |
| link | TEXT | 記事URL |
| description | TEXT | 本文/要約 |
| author | TEXT | 著者 |
| published_at | TEXT | 公開日時 |
| fetched_at | TEXT | 取得日時 |

### 3.3 既読位置

| 属性 | 型 | 説明 |
|------|-----|------|
| id | INTEGER | ID |
| user_id | INTEGER | ユーザーID |
| feed_id | INTEGER | フィードID |
| last_read_item_id | INTEGER | 最後に読んだ記事ID |
| last_read_at | TEXT | 最終閲覧日時 |

## 4. 画面構成

### 4.1 フィード一覧

```
================================================================================
    RSSフィード一覧                                         未読合計: 45件
================================================================================
    No.  フィード名                        未読   最終更新
     1   Hacker News                         10*  2025/01/15 20:00
     2   Ars Technica                        15*  2025/01/15 19:45
     3   TechCrunch                           5*  2025/01/15 19:30
     4   Slashdot                            10*  2025/01/15 18:00
     5   The Verge                            5*  2025/01/15 17:30
--------------------------------------------------------------------------------
    [番号] 記事一覧    [U] 未読一気読み    [A] 全て既読    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 4.2 記事一覧

```
================================================================================
    Hacker News                                               未読: 10件
================================================================================
    No.  *   タイトル                                  日時
     1   *   Show HN: 新しいRust製エディタ            01/15 19:30
     2   *   OpenAIが新APIを発表                      01/15 18:45
     3   *   Linux 6.8リリース                        01/15 17:30
     4       Amazonの新倉庫ロボット                   01/15 16:00
     5       Apple Vision Pro発売日決定              01/15 15:00
--------------------------------------------------------------------------------
    [番号] 読む    [U] 未読一気読み    [A] 既読に    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 4.3 記事詳細

```
================================================================================
    Show HN: 新しいRust製エディタ
================================================================================
    フィード: Hacker News                    日時: 2025/01/15 19:30:00
    著者:     user123
    URL:      https://example.com/rust-editor
--------------------------------------------------------------------------------

    Rustで書かれた新しいテキストエディタを公開しました。

    主な特徴:
    - LSPサポート
    - 軽量で高速
    - クロスプラットフォーム

    GitHubでソースコードを公開しています。

--------------------------------------------------------------------------------
    [O] URLを開く    [N] 次    [P] 前    [Q] 一覧に戻る
--------------------------------------------------------------------------------
>
```

## 5. 管理機能

### 5.1 管理メニュー

```
管理メニュー:
  [20] フィード一覧
  [21] フィード追加
  [22] フィード編集
  [23] フィード削除
  [24] 手動更新
```

### 5.2 権限

| 操作 | 必要権限 |
|------|----------|
| フィード一覧表示 | SubOp+ |
| フィード追加 | SubOp+ |
| フィード編集 | SubOp+ |
| フィード削除 | SysOp |
| 手動更新 | SubOp+ |

## 6. 設定

config.tomlで以下の設定が可能：

```toml
[rss]
# RSS機能の有効/無効
enabled = true
# バックグラウンド更新間隔（秒）
update_interval_secs = 300
# フィードごとのデフォルト取得間隔（秒）
default_fetch_interval_secs = 3600
# フィード最大サイズ（バイト）
max_feed_size_bytes = 5242880
# フィードあたり最大記事数
max_items_per_feed = 100
# 記事本文最大長
max_content_length = 10000
# 接続タイムアウト（秒）
connect_timeout_secs = 10
# 読み込みタイムアウト（秒）
read_timeout_secs = 20
# 全体タイムアウト（秒）
total_timeout_secs = 30
# 最大リダイレクト回数
max_redirects = 5
# 自動無効化までのエラー回数
max_consecutive_errors = 5
```

## 7. セキュリティ

### 7.1 SSRF対策

以下のアドレスへのアクセスを禁止：

- プライベートIPアドレス（10.x, 172.16-31.x, 192.168.x, 127.x）
- ループバックアドレス
- リンクローカルアドレス
- localhost, .local, .internal ホスト名

### 7.2 リソース制限

- フィードサイズ上限: 5MB
- タイムアウト: 接続10秒、読み込み20秒、全体30秒
- リダイレクト回数上限: 5回

### 7.3 エラーハンドリング

- 連続5回エラーでフィード自動無効化
- エラー回数とメッセージをDBに記録
- 管理画面でエラー状況を確認可能

## 8. バックグラウンド更新

サーバ起動時にバックグラウンドタスクが開始され、設定された間隔で更新をチェック：

1. 更新が必要なフィード（last_fetched_at + fetch_interval < 現在時刻）を取得
2. 各フィードを順次取得・パース
3. 新しい記事をDBに保存（重複は無視）
4. 古い記事を削除（上限超過分）
5. エラー時はerror_countをインクリメント

## 9. 操作フロー

### 9.1 記事閲覧フロー

```
メインメニュー
    ↓ [N]
フィード一覧
    ↓ [1]
記事一覧
    ↓ [1]
記事詳細
    ↓ [N]
次の記事
    ↓ [Q]
記事一覧に戻る
```

### 9.2 フィード追加フロー

```
管理メニュー
    ↓ [21]
URL入力
    ↓
フィード取得・検証
    ↓
登録完了
```

## 10. 制限事項

| 項目 | 制限値 |
|------|--------|
| フィード最大サイズ | 5MB |
| フィードあたり記事数 | 100件 |
| 記事本文最大長 | 10,000文字 |
| 1ページ表示件数 | 20件 |
| デフォルト更新間隔 | 1時間 |
