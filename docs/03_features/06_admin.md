# HOBBS - 機能仕様書: 管理者機能

## 1. 概要

SysOp/SubOpによるシステム管理機能。掲示板・フォルダ・ユーザーの管理を行う。

## 2. 権限による機能分担

| 機能 | SubOp | SysOp |
|------|-------|-------|
| 掲示板一覧確認 | ○ | ○ |
| 掲示板追加 | ○ | ○ |
| 掲示板編集 | ○ | ○ |
| 掲示板削除 | × | ○ |
| フォルダ管理 | ○ | ○ |
| 投稿削除 | ○ | ○ |
| ユーザー一覧 | ○ | ○ |
| ユーザー編集 | △* | ○ |
| 権限変更 | × | ○ |
| 接続ユーザー確認 | ○ | ○ |
| 強制切断 | × | ○ |
| システム設定 | × | ○ |

△* = 一般会員のみ編集可能

## 3. 管理メニュー

```
================================================================================
    管理メニュー                                              権限: SysOp
================================================================================

    === 掲示板管理 ===
    [1] 掲示板一覧・編集
    [2] 掲示板追加
    [3] 投稿削除

    === ファイル管理 ===
    [4] フォルダ一覧・編集
    [5] フォルダ追加
    [6] ファイル削除

    === ユーザー管理 ===
    [7] ユーザー一覧
    [8] ユーザー編集
    [9] 権限変更          ※SysOp専用

    === システム ===
    [0] 接続中ユーザー一覧

    [Q] メインメニューに戻る
--------------------------------------------------------------------------------
選択 >
```

## 4. 掲示板管理

### 4.1 掲示板一覧・編集

```
================================================================================
    掲示板管理
================================================================================

    No.  掲示板名                形式      閲覧権限    投稿権限    状態
    ───────────────────────────────────────────────────────────────────────
     1   お知らせ              フラット    guest       sysop       有効
     2   雑談                  スレッド    member      member      有効
     3   質問                  スレッド    member      member      有効
     4   テスト（非公開）      スレッド    sysop       sysop       停止

--------------------------------------------------------------------------------
    [番号] 編集    [A] 追加    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 4.2 掲示板追加

```
================================================================================
    掲示板追加
================================================================================

    掲示板名: _

    説明: _

    形式: [1] スレッド形式    [2] フラット形式

    閲覧権限: [1] guest  [2] member  [3] subop  [4] sysop

    投稿権限: [1] guest  [2] member  [3] subop  [4] sysop

--------------------------------------------------------------------------------
    [S] 保存    [C] キャンセル
--------------------------------------------------------------------------------
>
```

### 4.3 掲示板編集

```
================================================================================
    掲示板編集: 雑談
================================================================================

    [1] 名前変更        現在: 雑談
    [2] 説明変更        現在: 自由に語り合いましょう
    [3] 閲覧権限変更    現在: member
    [4] 投稿権限変更    現在: member
    [5] 表示順変更      現在: 2
    [6] 有効/停止切替   現在: 有効
    [D] 削除            ※SysOp専用

    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

## 5. フォルダ管理

### 5.1 フォルダ一覧・編集

```
================================================================================
    フォルダ管理
================================================================================

    No.  フォルダ名              閲覧権限    UP権限      ファイル数
    ───────────────────────────────────────────────────────────────────────
     1   共有ファイル            member      subop           15
     2   └─ ドキュメント         member      subop            8
     3   └─ 画像                 member      subop            5
     4   フリーソフト            guest       subop           23
     5   会員専用                member      member          12

--------------------------------------------------------------------------------
    [番号] 編集    [A] 追加    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 5.2 フォルダ追加

```
入力項目：
- フォルダ名
- 説明
- 親フォルダ（ルートまたは既存フォルダ）
- 閲覧権限
- アップロード権限
```

## 6. ユーザー管理

### 6.1 ユーザー一覧

```
================================================================================
    ユーザー管理
================================================================================

    No.  ユーザーID      ニックネーム      権限      登録日      状態
    ───────────────────────────────────────────────────────────────────────
     1   sysop           SysOp             sysop     2024/12/01  有効
     2   たろう          たろう            member    2024/12/15  有効
     3   はなこ          はなこ            member    2024/12/20  有効
     4   じろう          じろう            subop     2025/01/01  有効
     5   退会太郎        退会太郎          member    2024/12/10  停止

    ページ: 1/3    [N] 次    [P] 前
--------------------------------------------------------------------------------
    [番号] 詳細・編集    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 6.2 ユーザー詳細・編集

```
================================================================================
    ユーザー詳細: たろう
================================================================================

    ユーザーID:   たろう
    ニックネーム: たろう
    メール:       taro@example.com
    権限:         member
    登録日:       2024/12/15
    最終ログイン: 2025/01/15 18:30
    投稿数:       45件
    状態:         有効

    [1] ニックネーム変更
    [2] パスワードリセット
    [3] 権限変更          ※SysOp専用
    [4] アカウント停止/復活

    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 6.3 権限変更（SysOp専用）

```
================================================================================
    権限変更: たろう
================================================================================

    現在の権限: member

    変更後の権限を選択:
    [1] member  - 一般会員
    [2] subop   - 副管理者
    [3] sysop   - システム管理者

    [C] キャンセル
--------------------------------------------------------------------------------
選択 >
```

## 7. 接続ユーザー管理

### 7.1 接続中ユーザー一覧

```
================================================================================
    接続中ユーザー
================================================================================

    No.  ユーザーID      IPアドレス         接続時刻        状態
    ───────────────────────────────────────────────────────────────────────
     1   たろう          192.168.1.10       20:15:30        チャット中
     2   はなこ          192.168.1.20       20:20:45        掲示板閲覧
     3   じろう          192.168.1.30       20:25:00        アイドル
     4   (ゲスト)        192.168.1.40       20:30:15        掲示板閲覧

    現在の接続数: 4 / 最大: 20
--------------------------------------------------------------------------------
    [番号] 強制切断（SysOp専用）    [R] 更新    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 7.2 強制切断

```
たろう (192.168.1.10) を強制切断しますか？ [Y/N] >
```

## 8. 投稿削除

### 8.1 投稿検索・削除

```
================================================================================
    投稿削除
================================================================================

    検索条件:
    [1] 掲示板から選択
    [2] ユーザーIDで検索
    [3] キーワードで検索

    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

削除時：
- 論理削除（content を「この投稿は削除されました」に置換）
- または物理削除（設定による）

## 9. システム設定（SysOp専用）

```
================================================================================
    システム設定
================================================================================

    === サーバ設定 ===
    [1] BBS名称          現在: HOBBS
    [2] ウェルカムメッセージ
    [3] アイドルタイムアウト  現在: 300秒
    [4] 最大接続数       現在: 20

    === 制限設定 ===
    [5] 投稿最大文字数   現在: 10000
    [6] ファイル最大サイズ  現在: 10MB

    [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

## 10. API仕様

```rust
pub trait AdminService {
    // 掲示板管理
    async fn create_board(&self, data: CreateBoard, admin: &User) -> Result<Board>;
    async fn update_board(&self, id: i64, data: UpdateBoard, admin: &User) -> Result<Board>;
    async fn delete_board(&self, id: i64, admin: &User) -> Result<()>;

    // フォルダ管理
    async fn create_folder(&self, data: CreateFolder, admin: &User) -> Result<Folder>;
    async fn update_folder(&self, id: i64, data: UpdateFolder, admin: &User) -> Result<Folder>;
    async fn delete_folder(&self, id: i64, admin: &User) -> Result<()>;

    // ユーザー管理
    async fn list_users(&self, page: u32, admin: &User) -> Result<Page<User>>;
    async fn update_user(&self, id: i64, data: UpdateUser, admin: &User) -> Result<User>;
    async fn change_role(&self, id: i64, new_role: Role, admin: &User) -> Result<()>;
    async fn suspend_user(&self, id: i64, admin: &User) -> Result<()>;
    async fn activate_user(&self, id: i64, admin: &User) -> Result<()>;

    // 投稿管理
    async fn delete_post(&self, id: i64, admin: &User) -> Result<()>;
    async fn delete_file(&self, id: i64, admin: &User) -> Result<()>;

    // セッション管理
    async fn list_sessions(&self) -> Result<Vec<SessionInfo>>;
    async fn force_disconnect(&self, session_id: Uuid, admin: &User) -> Result<()>;
}
```

## 11. 監査ログ（将来検討）

管理操作のログ記録：

```sql
CREATE TABLE audit_logs (
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    admin_id    INTEGER NOT NULL REFERENCES users(id),
    action      TEXT NOT NULL,     -- 'create_board', 'delete_post', etc.
    target_type TEXT NOT NULL,     -- 'board', 'user', 'post', etc.
    target_id   INTEGER,
    details     TEXT,              -- JSON形式の詳細
    ip_address  TEXT,
    created_at  TEXT NOT NULL DEFAULT (datetime('now'))
);
```
