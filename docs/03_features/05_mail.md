# HOBBS - 機能仕様書: 内部メール

## 1. 概要

BBS内部での会員間プライベートメッセージ機能。外部メールサーバとの連携はなし。

## 2. 基本仕様

| 項目 | 仕様 |
|------|------|
| 送受信範囲 | BBS内部のみ |
| 利用資格 | 会員のみ |
| 添付ファイル | なし |
| 既読管理 | あり |

## 3. メールの属性

| 属性 | 型 | 説明 |
|------|-----|------|
| id | INTEGER | メールID |
| from_id | INTEGER | 送信者ID |
| to_id | INTEGER | 受信者ID |
| subject | TEXT | 件名 |
| body | TEXT | 本文 |
| is_read | INTEGER | 既読フラグ |
| is_deleted_by_sender | INTEGER | 送信者削除フラグ |
| is_deleted_by_receiver | INTEGER | 受信者削除フラグ |
| created_at | TEXT | 送信日時 |

## 4. 画面構成

### 4.1 受信箱

```
================================================================================
    メールボックス - 受信箱                                    未読: 2通
================================================================================

    No.  状態  差出人          件名                    日時
    ───────────────────────────────────────────────────────────────────────
     1   ●    はなこ          Re: 週末の件            01/15 19:00
     2   ●    SysOp           ようこそHOBBSへ         01/15 12:00
     3        じろう          お元気ですか？          01/14 20:30
     4        はなこ          週末の件                01/13 18:00
     5        さぶろう        先日はありがとう        01/10 15:00

    ● = 未読    ページ: 1/1
--------------------------------------------------------------------------------
    [番号] 読む  [W] 新規作成  [S] 送信箱  [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 4.2 送信箱

```
================================================================================
    メールボックス - 送信箱
================================================================================

    No.  宛先            件名                    日時
    ───────────────────────────────────────────────────────────────────────
     1   はなこ          週末の件について        01/13 17:30
     2   じろう          ありがとう              01/10 12:00

    ページ: 1/1
--------------------------------------------------------------------------------
    [番号] 読む  [R] 受信箱  [Q] 戻る
--------------------------------------------------------------------------------
選択 >
```

### 4.3 メール詳細

```
================================================================================
    メール詳細
================================================================================
    差出人: はなこ                              日時: 2025/01/15 19:00:00
    宛先:   たろう
    件名:   Re: 週末の件
--------------------------------------------------------------------------------

    たろうさん

    週末の集まり、了解しました！
    15時に駅前で待ち合わせですね。

    楽しみにしています。

    はなこ

--------------------------------------------------------------------------------
    [R] 返信    [D] 削除    [N] 次    [P] 前    [Q] 一覧に戻る
--------------------------------------------------------------------------------
>
```

### 4.4 新規作成

```
================================================================================
    新規メール作成
================================================================================

    宛先ユーザーID: _

    件名: _

    本文を入力してください（終了は「.」のみの行）:
    ---


    .
    ---

--------------------------------------------------------------------------------
    [S] 送信    [C] キャンセル
--------------------------------------------------------------------------------
>
```

## 5. 機能詳細

### 5.1 メール一覧（受信箱）

```
表示項目：
- メール番号
- 未読マーク（●）
- 差出人
- 件名（長い場合は省略）
- 受信日時

ソート：
- 受信日時降順（新しい順）
```

### 5.2 メール一覧（送信箱）

```
表示項目：
- メール番号
- 宛先
- 件名
- 送信日時

ソート：
- 送信日時降順
```

### 5.3 メール作成

```
入力項目：
1. 宛先ユーザーID
   - 存在確認
   - 退会済みチェック
2. 件名（1-50文字）
3. 本文（.で終了）

確認：
- 送信確認（Y/N）
```

### 5.4 メール返信

```
自動設定項目：
- 宛先: 元メールの送信者
- 件名: "Re: " + 元の件名

入力項目：
- 本文のみ

引用：
- 元メッセージの引用は手動で行う
```

### 5.5 メール削除

- 受信箱から削除: is_deleted_by_receiver = 1
- 送信箱から削除: is_deleted_by_sender = 1
- 両方が削除済みになったら物理削除（オプション）

### 5.6 既読管理

- メール詳細を開いた時点で is_read = 1
- 未読件数はログイン時・メニュー表示時に計算

## 6. 操作フロー

### 6.1 メール閲覧フロー

```
メインメニュー（未読: 2通 表示）
    ↓ [M]
受信箱
    ↓ [1]
メール詳細（→ 既読化）
    ↓ [Q]
受信箱に戻る
```

### 6.2 新規作成フロー

```
受信箱
    ↓ [W]
宛先入力
    ↓
件名入力
    ↓
本文入力（.で終了）
    ↓
送信確認 [Y]
    ↓
送信完了
    ↓
受信箱に戻る
```

### 6.3 返信フロー

```
メール詳細
    ↓ [R]
本文入力（.で終了）
    ↓
送信確認 [Y]
    ↓
送信完了
    ↓
メール詳細に戻る
```

## 7. 通知

### 7.1 ログイン時通知

```
新着メールがあります: 2通
```

### 7.2 メインメニュー表示

```
[M] メール            - 会員間メッセージ (未読: 2通)
```

## 8. API仕様

```rust
pub trait MailService {
    /// 受信メール一覧取得
    async fn list_inbox(&self, user_id: i64, page: u32) -> Result<Page<Mail>>;

    /// 送信メール一覧取得
    async fn list_sent(&self, user_id: i64, page: u32) -> Result<Page<Mail>>;

    /// メール詳細取得（既読化も行う）
    async fn get_mail(&self, id: i64, user_id: i64) -> Result<Mail>;

    /// メール送信
    async fn send_mail(&self, data: SendMail) -> Result<Mail>;

    /// メール削除
    async fn delete_mail(&self, id: i64, user_id: i64, box_type: BoxType) -> Result<()>;

    /// 未読件数取得
    async fn unread_count(&self, user_id: i64) -> Result<u32>;
}

#[derive(Debug)]
pub struct SendMail {
    pub from_id: i64,
    pub to_username: String,  // ユーザーIDで指定
    pub subject: String,
    pub body: String,
}

#[derive(Debug)]
pub enum BoxType {
    Inbox,
    Sent,
}
```

## 9. 制限事項

| 項目 | 制限値 |
|------|--------|
| 件名最大長 | 50文字 |
| 本文最大長 | 10,000文字 |
| 保存件数上限 | なし（将来検討） |
| 1ページ表示件数 | 20件 |

## 10. システムメール

SysOpからの自動送信メール：

- ようこそメール（新規登録時）
- 重要なお知らせ
- アカウント関連通知

```rust
fn send_welcome_mail(user: &User) -> Result<()> {
    let mail = SendMail {
        from_id: SYSOP_USER_ID,
        to_username: user.username.clone(),
        subject: "ようこそ HOBBS へ！".to_string(),
        body: format!(
            "{}さん\n\n\
            HOBBSへの登録ありがとうございます。\n\n\
            掲示板やチャットで楽しいコミュニケーションを\n\
            お楽しみください。\n\n\
            何かわからないことがあれば、\n\
            お気軽にSysOpまでご連絡ください。\n\n\
            HOBBS SysOp",
            user.nickname
        ),
    };
    mail_service.send_mail(mail)
}
```
